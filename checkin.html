<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>受付フォーム</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { font-size: 1em; padding: 8px; }
    #result { margin-top: 20px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>来場者 受付フォーム</h2>
  <input type="text" id="nameInput" placeholder="カタカナを入力" />
  <button onclick="searchName()">検索</button>
  <div id="result">検索結果がここに表示されます</div>
  <button id="checkinButton" style="display:none" onclick="markAsCheckedIn()">受付する</button>

  <script>
    const endpoint = "https://reception.esthepro-shinya.workers.dev/";
    let matchedRow = null;

    function searchName() {
      const input = document.getElementById("nameInput").value.trim();
      const resultDiv = document.getElementById("result");
      const checkinButton = document.getElementById("checkinButton");
      resultDiv.textContent = "🔄 検索中...";
      checkinButton.style.display = "none";

      fetch(endpoint)
        .then((res) => res.json())
        .then((data) => {
          matchedRow = data.find((row) => row["カタカナ"] && row["カタカナ"].includes(input));
          if (matchedRow) {
            resultDiv.textContent = `✅ ${matchedRow["お名前"]} さん（${matchedRow["店舗"]} / ${matchedRow["お席"]}）`;
            checkinButton.style.display = "inline-block";
          } else {
            resultDiv.textContent = "⚠️ 該当者が見つかりません";
          }
        })
        .catch((err) => {
          resultDiv.textContent = "⚠️ データ取得に失敗しました";
        });
    }

    function markAsCheckedIn() {
      if (!matchedRow) return;
      const resultDiv = document.getElementById("result");
      resultDiv.textContent = "🔄 登録中...";

      const postData = new URLSearchParams();
      postData.append("name", matchedRow["お名前"]);
      postData.append("store", matchedRow["店舗"]);
      postData.append("seat", matchedRow["お席"]);

      fetch(endpoint, {
        method: "POST",
        body: postData,
      })
        .then((res) => res.text())
        .then((text) => {
          resultDiv.textContent = `🎉 ${matchedRow["お名前"]} さんを受付済みにしました！`;
          document.getElementById("checkinButton").style.display = "none";
        })
        .catch(() => {
          resultDiv.textContent = "⚠️ 登録に失敗しました : Failed to fetch";
        });
    }
  </script>
</body>
</html>
